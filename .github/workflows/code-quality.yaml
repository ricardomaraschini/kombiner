name: Code quality checks

on:
  push:
    branches:
    - main
  pull_request:
    branches:
    - main

jobs:
  build-test-lint:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Conventional commit
      uses: ytanikin/pr-conventional-commits@1.4.2
      if: github.ref != 'refs/heads/main'
      with:
        task_types: '["ci","feat","fix","docs","test","chore","revert"]'
        add_label: false

    - name: Setup go
      uses: actions/setup-go@v5
      with:
        go-version: "1.24"

    - name: Check autogenerated code
      run: make generate && git diff --exit-code

    - name: Run unit tests
      run: make test-unit

    - name: Run go vet
      run: go vet ./...

    - name: Run staticcheck
      run: go tool staticcheck ./...

    - name: Validate format
      run: make format && git diff --exit-code

    - name: Build
      run: make build
